---
title: '[Java并发][1][并发编程的挑战]'
date: 2020-11-11 17:18:26
tags:
    - Java
    - 并发
categories:
    - Java并发
---
## 第 1 章 并发编程的挑战



并发编程的目的是为了让程序运行得更快，但是，**并不是启动更多的线程就能让程序最大限度地并发执行。**在进行并发编程时，如果希望通过多线程执行任务让程序运行得更快，会面临非常多的**挑战**，比如**上下文切换**的问题、**死锁**的问题，以及**受限于硬件和软件的资源限制**
问题，本章会介绍几种并发编程的挑战以及解决方案。



### 1.1 上下文切换



即使是单核处理器也支持多线程执行代码，CPU通过**给每个线程分配CPU时间片**来实现这个机制。时间片是CPU分配给各个线程的时间，因为时间片非常短，所以CPU通过不停地切换线程执行，让我们感觉多个线程是同时执行的，时间片一般是几十毫秒（ms）。



CPU通过时间片分配算法来循环执行任务，当前任务执行一个时间片后会切换到下一个任务。但是，在切换前会保存上一个任务的状态，以便下次切换回这个任务时，可以再加载这个任务的状态。所以**任务从保存到再加载的过程就是一次上下文切换**。



但是**上下文切换**也会**影响多线程的执行速度**。为什么并发执行的速度会比串行慢呢？这是因为线程有创建和上下文切换的**额外开销**。



**减少上下文切换的方法**有无锁并发编程、CAS算法、使用最少线程和使用协程。

- **无锁并发编程**：多线程**竞争锁**时，会引起上下文切换，所以多线程**一起处理某数据**时，可以用一些办法来**避免使用锁**，如将数据的ID按照Hash算法取模分段，不同的线程处理不同段的数据。
- **CAS算法**：Java的Atomic包使用CAS算法来更新数据，而不需要加锁。
- **使用最少线程**：**避免创建不需要的线程**，比如任务很少，但是创建了很多线程来处理，这样会造成大量线程都处于等待状态。
- **协程**：在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换。



### 1.2 死锁



**锁**是个非常有用的工具，运用场景非常多，因为它使用起来非常简单，而且易于理解。但同时它也会带来一些困扰，那就是**可能会引起死锁**，一旦产生死锁，就会造成系统功能不可用



现在我们介绍**避免死锁**的几个常见方法。

- **避免**一个线程**同时获取多个锁**。
- **避免**一个线程**在锁内同时占用多个资源**，尽量保证每个锁只占用一个资源。
- 尝试**使用定时锁**，使用`lock.tryLock(timeout)`来替代使用内部锁机制。
- 对于数据库锁**，加锁和解锁必须在一个数据库连接里**，否则会出现解锁失败的情况。



### 1.3 资源限制的挑战



#### 1.3.1 什么是资源限制



**资源限制**是指在进行并发编程时，**程序的执行速度受限于计算机硬件资源或软件资源**。硬件资源限制有带宽的上传/下载速度、硬盘读写速度和CPU的处理速度。软件资源限制有数据库的连接数和socket连接数等。



#### 1.3.2 资源限制引发的问题



在并发编程中，将代码执行速度加快的原则是**将代码中串行执行的部分变成并发执行**，但是如果将某段串行的代码并发执行，**因为受限于资源，仍然在串行执行，这时候程序不仅不会加快执行，反而会更慢，因为增加了上下文切换和资源调度的时间。**



#### 1.3.3 如何解决资源限制的问题



对于**硬件资源限制**，可以考虑**使用集群并行执行程序**。既然单机的资源有限制，那么就让程序在多机上运行。



对于**软件资源限制**，可以考虑**使用资源池将资源复用**。比如使用连接池将数据库和Socket连接复用，或者在调用对方webservice接口获取数据时，只建立一个连接。



#### 1.3.4 在资源限制情况下进行并发编程



如何在资源限制的情况下，让程序执行得更快呢？方法就是，**根据不同的资源限制调整程序的并发度**，比如下载文件程序依赖于两个资源——带宽和硬盘读写速度。有数据库操作时，涉及数据库连接数，如果SQL语句执行非常快，而线程的数量比数据库连接数大很多，则某些线程会被阻塞，等待数据库连接。



